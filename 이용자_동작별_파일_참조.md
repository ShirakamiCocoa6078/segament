# 이용자 동작별 파일 참조 및 미사용 파일 분석

이 문서는 사용자의 주요 행동 흐름에 따라 참조 및 실행되는 파일들의 순서와 역할을 정리하고, 현재 코드베이스에 존재하지만 기능하지 않는 파일들을 분석합니다.

## 1. 사용자 주요 행동 흐름 분석

### 가. 최초 접속 ~ 로그인

1.  **사용자:** 웹사이트 최초 접속 (`https://...`)
    -   `src/app/layout.tsx`: 모든 페이지의 기본 레이아웃을 정의합니다. `SessionProvider`를 통해 인증 상태를 관리합니다.
    -   `src/app/page.tsx`: 메인 페이지 UI를 렌더링합니다.
    -   `src/components/ui/Header.tsx` (가정): 헤더 컴포넌트. 로그인 상태에 따라 '로그인' 또는 '프로필' 버튼을 표시합니다.

2.  **사용자:** '로그인' 버튼 클릭
    -   `src/lib/auth.ts`: NextAuth.js 설정 파일. 소셜 로그인 제공자(Google, Discord 등) 정보를 바탕으로 인증 과정을 처리합니다.
    -   `prisma/schema.prisma`: 로그인 시 `User`, `Account`, `Session` 모델을 참조하여 사용자 정보를 조회하거나 새로 생성합니다.

### 나. 데이터 가져오기 (북마크릿 동기화)

1.  **사용자:** 게임 공식 사이트에서 북마크릿 실행
    -   `public/scripts/segamentImporter.js`: 북마크릿의 시작점. `segament-getChu.js` 스크립트를 웹페이지에 주입하고, 데이터 수신을 위한 `/import` 페이지를 팝업으로 엽니다.

2.  **스크립트:** 데이터 수집 및 전송
    -   `public/scripts/segament-getChu.js`: 게임 사이트의 HTML을 파싱하여 `profile`, `gameData` 등 필요한 모든 정보를 수집하고, v4 스키마에 맞는 JSON 객체로 가공합니다.
    -   `src/app/import/page.tsx`: 팝업으로 열리는 페이지. `window.postMessage`를 통해 `segament-getChu.js`가 보낸 데이터 페이로드를 수신합니다.

3.  **프론트엔드 -> 백엔드:** API 호출
    -   `src/app/import/page.tsx`: 수신한 데이터를 Body에 담아 `/api/v1/import/chunithm` API로 `POST` 요청을 보냅니다.

4.  **백엔드:** 데이터베이스 저장
    -   `src/app/api/v1/import/chunithm/route.ts`: API 요청을 수신하고, NextAuth.js 세션을 통해 사용자를 인증합니다.
    -   `prisma/schema.prisma`: `GameProfile` 모델의 구조를 참조하여 데이터를 저장(`upsert`)합니다.
    -   `ratingHistory` 업데이트, `lastPlayDate` 타입 변환 등 모든 데이터 가공 및 저장 로직을 수행합니다.

### 다. 프로필 데이터 조회 및 표시

1.  **사용자:** 자신의 프로필 페이지로 이동 (`/profile` 등)
    -   `src/app/profile/page.tsx` (가정): 프로필 페이지. 내부적으로 `/api/system/v1/profile`을 호출하여 데이터를 가져옵니다.

2.  **프론트엔드 -> 백엔드:** 시스템 API 호출
    -   `fetch('/api/system/v1/profile?gameType=CHUNITHM&region=JP')`: 현재 로그인된 사용자의 프로필 데이터를 요청합니다.

3.  **백엔드:** 데이터 조회 및 반환
    -   `src/app/api/system/v1/profile/route.ts`: 세션을 통해 사용자를 확인하고, 쿼리 파라미터(`gameType`, `region`)를 확인합니다.
    -   `src/lib/dataService.ts`: `getGameProfileByUserSystemId` 함수를 통해 Prisma 쿼리를 실행합니다.
    -   `prisma/schema.prisma`: `GameProfile` 모델에서 데이터를 조회합니다.
    -   조회된 프로필 데이터를 JSON 형태로 프론트엔드에 반환합니다.

4.  **프론트엔드:** 데이터 표시
    -   `src/app/profile/page.tsx`: API로부터 받은 데이터를 사용하여 프로필 UI를 렌더링합니다.
    -   `src/components/RatingCard.tsx` (가정): 프로필 데이터의 일부를 받아 레이팅, 플레이 횟수 등을 표시하는 컴포넌트.

---

## 2. 미사용 또는 기능하지 않는 파일 분석

현재 코드베이스에는 새로운 아키텍처 도입 및 리팩토링 과정에서 더 이상 사용되지 않거나, 기능이 대체된 파일들이 남아있을 수 있습니다.

### 가. `src/app/api/v1/img/MakeRatingImg/route.ts`

-   **역할 (과거):** 사용자의 레이팅 정보를 기반으로 동적인 프로필 이미지를 생성하는 API 라우트였습니다.
-   **기능하지 않는 이유:**
    1.  **데이터 접근 방식 변경:** 이 파일은 `prisma`를 직접 호출하여 데이터베이스에서 정보를 가져왔습니다. 새로운 아키텍처에서는 `dataService.ts`나 시스템 API (`/api/system/...`)를 통해 데이터를 가져와야 합니다.
    2.  **스키마 변경 미반영:** v4 스키마 변경(예: `GameData` 테이블 제거, `ratingLists` 필드 위치 변경)이 반영되지 않아, 현재 코드를 그대로 실행하면 오류가 발생합니다.
-   **현 상태:** 리팩토링이 필요한 **레거시 코드**로 남아있습니다. 정상적으로 작동하려면 새로운 시스템 API를 호출하여 프로필 데이터를 가져온 후, 그 데이터를 기반으로 이미지를 생성하도록 코드를 전면 수정해야 합니다.

### 나. `src/lib/ratingUtils.ts` (일부 함수)

-   **역할:** 레이팅 계산과 관련된 유틸리티 함수들을 포함합니다.
-   **일부 기능하지 않을 수 있는 이유:**
    -   과거 `B30`, `N20` 같은 특정 데이터 구조를 가정하고 만들어진 함수가 있다면, 현재 `ratingLists` JSON 구조와 맞지 않아 정상 작동하지 않을 수 있습니다.
    -   `calculateRating` 함수 자체는 상수와 점수만으로 계산하므로 여전히 유효하지만, 이 함수를 호출하는 상위 로직들이 새로운 데이터 구조에 맞게 수정되었는지 검토가 필요합니다.
-   **현 상태:** 핵심 계산 로직은 유효하나, 새로운 데이터 구조에 맞춰 함수 시그니처나 호출 방식의 리팩토링이 필요할 수 있는 파일입니다.
